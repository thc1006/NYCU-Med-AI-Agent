"""
è·¯ç”±å™¨ç‰¹å®šçš„ OpenAPI æ–‡ä»¶å¢å¼·
ç‚ºæ¯å€‹ API è·¯ç”±å™¨æ·»åŠ å°ç£é†«ç™‚ç‰¹è‰²çš„æ–‡ä»¶å¢å¼·åŠŸèƒ½
"""

from typing import Dict, Any, List
from fastapi import APIRouter
from fastapi.openapi.models import Tag


# å°ç£é†«ç™‚å°ˆç§‘å°ç…§è¡¨
TAIWAN_MEDICAL_SPECIALTIES = {
    "å¿ƒè‡Ÿå…§ç§‘": {
        "english": "Cardiology",
        "symptoms": ["èƒ¸ç—›", "èƒ¸æ‚¶", "å¿ƒæ‚¸", "å¿ƒè·³ç•°å¸¸", "é«˜è¡€å£“"],
        "emergency_keywords": ["å¿ƒè‚Œæ¢—å¡", "å¿ƒè‡Ÿç—…ç™¼ä½œ", "èƒ¸ç—›"]
    },
    "èƒ¸è…”å…§ç§‘": {
        "english": "Pulmonology",
        "symptoms": ["å‘¼å¸å›°é›£", "å’³å—½", "æ°£å–˜", "èƒ¸éƒ¨ä¸é©", "å’³è¡€"],
        "emergency_keywords": ["å‘¼å¸å›°é›£", "æ°£å–˜ç™¼ä½œ", "å’³è¡€"]
    },
    "ç¥ç¶“å…§ç§‘": {
        "english": "Neurology",
        "symptoms": ["é ­ç—›", "é ­æšˆ", "éº»ç—º", "æ‰‹è…³ç„¡åŠ›", "è¨˜æ†¶åŠ›æ¸›é€€"],
        "emergency_keywords": ["ä¸­é¢¨", "æ„è­˜ä¸æ¸…", "åŠ‡çƒˆé ­ç—›", "éº»ç—º"]
    },
    "è…¸èƒƒå…§ç§‘": {
        "english": "Gastroenterology",
        "symptoms": ["è…¹ç—›", "å˜”å", "è…¹ç€‰", "ä¾¿ç§˜", "æ¶ˆåŒ–ä¸è‰¯"],
        "emergency_keywords": ["åŠ‡çƒˆè…¹ç—›", "å¤§é‡å˜”å", "ä¾¿è¡€"]
    },
    "æ€¥è¨ºç§‘": {
        "english": "Emergency Medicine",
        "symptoms": ["å‰µå‚·", "ä¸­æ¯’", "æ€¥æ€§ç—…ç—‡", "æ„å¤–å‚·å®³"],
        "emergency_keywords": ["æ‰€æœ‰ç·Šæ€¥ç—‡ç‹€"]
    }
}

# å°ç£é†«é™¢å±¤ç´šèªªæ˜
TAIWAN_HOSPITAL_LEVELS = {
    "é†«å­¸ä¸­å¿ƒ": {
        "description": "æœ€é«˜å±¤ç´šé†«ç™‚é™¢æ‰€ï¼Œå…·å‚™å®Œæ•´å°ˆç§‘èˆ‡æ€¥é‡ç—‡ç…§è­·èƒ½åŠ›",
        "capabilities": ["è¤‡é›œæ‰‹è¡“", "é‡ç—‡åŠ è­·", "å™¨å®˜ç§»æ¤", "ç™Œç—‡æ²»ç™‚"],
        "bed_count": "é€šå¸¸ > 500 åºŠ"
    },
    "å€åŸŸé†«é™¢": {
        "description": "æä¾›å€åŸŸæ€§é†«ç™‚æœå‹™ï¼Œå…·å‚™å¤šå°ˆç§‘è¨ºç™‚èƒ½åŠ›",
        "capabilities": ["å°ˆç§‘è¨ºç™‚", "æ€¥è¨ºæœå‹™", "ä½é™¢æ²»ç™‚", "å¥åº·æª¢æŸ¥"],
        "bed_count": "é€šå¸¸ 250-500 åºŠ"
    },
    "åœ°å€é†«é™¢": {
        "description": "ç¤¾å€å‹é†«é™¢ï¼Œæä¾›åŸºæœ¬é†«ç™‚èˆ‡æ€¥è¨ºæœå‹™",
        "capabilities": ["åŸºæœ¬è¨ºç™‚", "æ€¥è¨ºæœå‹™", "ä½é™¢è§€å¯Ÿ", "é é˜²ä¿å¥"],
        "bed_count": "é€šå¸¸ < 250 åºŠ"
    },
    "è¨ºæ‰€": {
        "description": "åŸºå±¤é†«ç™‚é™¢æ‰€ï¼Œæä¾›é–€è¨ºèˆ‡é é˜²ä¿å¥æœå‹™",
        "capabilities": ["é–€è¨ºè¨ºç™‚", "é é˜²æ¥ç¨®", "å¥åº·è«®è©¢", "è½‰è¨ºæœå‹™"],
        "bed_count": "é€šå¸¸ < 20 åºŠæˆ–ç„¡ä½é™¢æœå‹™"
    }
}

# ç·Šæ€¥ç—‡ç‹€åˆ†é¡èˆ‡è™•ç†
EMERGENCY_SYMPTOM_CATEGORIES = {
    "ç«‹å³å±åŠç”Ÿå‘½": {
        "symptoms": ["å¿ƒè·³åœæ­¢", "å‘¼å¸åœæ­¢", "å¤§é‡å‡ºè¡€", "åš´é‡å‰µå‚·"],
        "action": "ç«‹å³æ’¥æ‰“ 119ï¼Œé€²è¡Œ CPR æ€¥æ•‘",
        "warning": "ğŸ†˜ ç”Ÿå‘½å±éšªï¼ç«‹å³æ€¥æ•‘ï¼"
    },
    "ç·Šæ€¥å°±é†«": {
        "symptoms": ["èƒ¸ç—›", "å‘¼å¸å›°é›£", "æ„è­˜æ¨¡ç³Š", "åŠ‡çƒˆé ­ç—›"],
        "action": "ç«‹å³å‰å¾€æ€¥è¨ºæˆ–æ’¥æ‰“ 119",
        "warning": "âš ï¸ ç·Šæ€¥ï¼è«‹ç«‹å³å°±é†«ï¼"
    },
    "ç›¡å¿«å°±é†«": {
        "symptoms": ["æŒçºŒé«˜ç‡’", "åŠ‡çƒˆè…¹ç—›", "åš´é‡å˜”å", "ç„¡æ³•é€²é£Ÿ"],
        "action": "24å°æ™‚å…§å‰å¾€æ€¥è¨ºæˆ–é–€è¨º",
        "warning": "âš¡ éœ€è¦ç›¡å¿«å°±é†«"
    },
    "å®‰æ’å°±é†«": {
        "symptoms": ["æŒçºŒå’³å—½", "é—œç¯€ç–¼ç—›", "çš®è†šå•é¡Œ", "æ¶ˆåŒ–ä¸è‰¯"],
        "action": "1-3å¤©å…§å®‰æ’é–€è¨º",
        "warning": "ğŸ“… å»ºè­°å®‰æ’å°±é†«"
    }
}


def enhance_triage_router_docs(router: APIRouter) -> Dict[str, Any]:
    """
    å¢å¼·ç—‡ç‹€åˆ†ç´šè·¯ç”±å™¨çš„æ–‡ä»¶

    Args:
        router: ç—‡ç‹€åˆ†ç´š APIRouter å¯¦ä¾‹

    Returns:
        Dict: å¢å¼·çš„æ–‡ä»¶è³‡è¨Š
    """
    enhanced_docs = {
        "description": """
        ## å°ç£é†«ç™‚ç—‡ç‹€åˆ†ç´šç³»çµ±

        ### åˆ†ç´šæ¨™æº–
        æœ¬ç³»çµ±æ¡ç”¨å››ç´šåˆ†ç´šåˆ¶åº¦ï¼š
        - **ğŸ†˜ emergency**: ç·Šæ€¥ç‹€æ³ï¼Œç«‹å³æ’¥æ‰“119
        - **âš¡ urgent**: ç·Šæ€¥ï¼Œç›¡å¿«å°±é†«ï¼ˆ24å°æ™‚å…§ï¼‰
        - **ğŸ“… outpatient**: å®‰æ’é–€è¨ºå°±é†«ï¼ˆ1-3å¤©å…§ï¼‰
        - **ğŸ  self-care**: å¯è‡ªæˆ‘ç…§è­·è§€å¯Ÿ

        ### ç´…æ——ç—‡ç‹€è‡ªå‹•åµæ¸¬
        ç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥ä»¥ä¸‹ç·Šæ€¥ç—‡ç‹€ï¼š
        """,
        "examples": {
            "emergency_chest_pain": {
                "summary": "æ€¥æ€§èƒ¸ç—› - ç–‘ä¼¼å¿ƒè‚Œæ¢—å¡",
                "description": "ç”·æ€§55æ­²ï¼Œçªç™¼èƒ¸ç—›ä¼´å†·æ±—",
                "value": {
                    "symptom_text": "èƒ¸éƒ¨åŠ‡ç—›ï¼Œæœ‰å£“è¿«æ„Ÿï¼Œå†·æ±—ç›´æµï¼Œç—›åˆ°å¾ŒèƒŒ",
                    "age": 55,
                    "gender": "M",
                    "duration_hours": 1,
                    "has_chronic_disease": True,
                    "medications": ["é™è¡€å£“è—¥"]
                }
            },
            "mild_cold": {
                "summary": "ä¸€èˆ¬æ„Ÿå†’ç—‡ç‹€",
                "description": "è¼•å¾®æ„Ÿå†’ï¼Œå¯è‡ªæˆ‘ç…§è­·",
                "value": {
                    "symptom_text": "æµé¼»æ°´ã€è¼•å¾®é ­ç—›ã€æœ‰é»ç–²å€¦",
                    "age": 30,
                    "gender": "F",
                    "duration_hours": 12
                }
            }
        },
        "emergency_categories": EMERGENCY_SYMPTOM_CATEGORIES,
        "specialties": TAIWAN_MEDICAL_SPECIALTIES
    }

    return enhanced_docs


def enhance_hospitals_router_docs(router: APIRouter) -> Dict[str, Any]:
    """
    å¢å¼·é†«é™¢æœå°‹è·¯ç”±å™¨çš„æ–‡ä»¶

    Args:
        router: é†«é™¢æœå°‹ APIRouter å¯¦ä¾‹

    Returns:
        Dict: å¢å¼·çš„æ–‡ä»¶è³‡è¨Š
    """
    enhanced_docs = {
        "description": """
        ## å°ç£é†«ç™‚é™¢æ‰€æœå°‹ç³»çµ±

        ### å®šä½æ–¹å¼
        æ”¯æ´ä¸‰ç¨®å®šä½æ–¹å¼ï¼ŒæŒ‰å„ªå…ˆç´šæ’åºï¼š
        1. **ç²¾ç¢ºåº§æ¨™** (latitude + longitude) - èª¤å·® < 10å…¬å°º
        2. **åœ°å€è§£æ** (address) - æ”¯æ´å°ç£åœ°å€æ ¼å¼
        3. **IPå®šä½** (use_ip=true) - èª¤å·®ç´„ 1-5 å…¬é‡Œ

        ### å°ç£é†«é™¢åˆ†ç´šåˆ¶åº¦
        """,
        "examples": {
            "taipei_search": {
                "summary": "å°åŒ—å¸‚ä¸­å¿ƒé†«é™¢æœå°‹",
                "description": "æœå°‹å°åŒ—è»Šç«™é™„è¿‘é†«é™¢",
                "parameters": {
                    "latitude": 25.0478,
                    "longitude": 121.5170,
                    "radius": 2000,
                    "max_results": 10
                }
            },
            "address_search": {
                "summary": "åœ°å€æœå°‹ç¯„ä¾‹",
                "description": "ä½¿ç”¨å°ç£åœ°å€æœå°‹é™„è¿‘é†«é™¢",
                "parameters": {
                    "address": "å°åŒ—å¸‚å¤§å®‰å€å¿ å­æ±è·¯å››æ®µ1è™Ÿ",
                    "radius": 3000,
                    "include_nhia": True
                }
            },
            "emergency_search": {
                "summary": "ç·Šæ€¥é†«é™¢æœå°‹",
                "description": "æ­é…ç—‡ç‹€çš„ç·Šæ€¥é†«é™¢æœå°‹",
                "parameters": {
                    "latitude": 25.0330,
                    "longitude": 121.5654,
                    "symptoms": ["èƒ¸ç—›", "å‘¼å¸å›°é›£"],
                    "radius": 3000
                }
            }
        },
        "hospital_levels": TAIWAN_HOSPITAL_LEVELS,
        "taiwan_addresses": [
            "å°åŒ—å¸‚ä¸­æ­£å€ä¸­å±±å—è·¯7è™Ÿï¼ˆå°å¤§é†«é™¢ï¼‰",
            "å°åŒ—å¸‚å…§æ¹–å€æˆåŠŸè·¯äºŒæ®µ325è™Ÿï¼ˆä¸‰ç¸½å…§æ¹–é™¢å€ï¼‰",
            "å°ä¸­å¸‚è¥¿å±¯å€å°ç£å¤§é“å››æ®µ1650è™Ÿï¼ˆä¸­åœ‹é†«è—¥å¤§å­¸é™„é†«ï¼‰",
            "é«˜é›„å¸‚ä¸‰æ°‘å€è‡ªç”±ä¸€è·¯100è™Ÿï¼ˆé«˜é†«é™„é†«ï¼‰"
        ]
    }

    return enhanced_docs


def enhance_meta_router_docs(router: APIRouter) -> Dict[str, Any]:
    """
    å¢å¼·å…ƒæ•¸æ“šè·¯ç”±å™¨çš„æ–‡ä»¶

    Args:
        router: å…ƒæ•¸æ“š APIRouter å¯¦ä¾‹

    Returns:
        Dict: å¢å¼·çš„æ–‡ä»¶è³‡è¨Š
    """
    enhanced_docs = {
        "description": """
        ## å°ç£æ€¥æ•‘èˆ‡ç·Šæ€¥è¯çµ¡ç³»çµ±

        ### ç·Šæ€¥è¯çµ¡é›»è©±
        - **119**: æ¶ˆé˜²æ•‘è­·å°ˆç·šï¼ˆç«ç½ã€æ•‘è­·è»Šã€ç·Šæ€¥æ•‘åŠ©ï¼‰
        - **110**: è­¦å¯Ÿå ±æ¡ˆå°ˆç·šï¼ˆæ²»å®‰ã€äº¤é€šäº‹æ•…ã€åˆ‘æ¡ˆå ±æ¡ˆï¼‰
        - **112**: æ‰‹æ©Ÿç·Šæ€¥æ’¥è™Ÿï¼ˆç„¡å¡ã€ç„¡è¨Šè™Ÿæ™‚çš„ç·Šæ€¥è™Ÿç¢¼ï¼‰
        - **113**: å©¦å¹¼ä¿è­·å°ˆç·šï¼ˆå®¶æš´ã€æ€§ä¾µã€å…’å°‘ä¿è­·ï¼‰

        ### ä½•æ™‚æ’¥æ‰“ 119
        """,
        "emergency_guidelines": {
            "when_to_call_119": [
                "å‘¼å¸å›°é›£æˆ–åœæ­¢å‘¼å¸",
                "èƒ¸ç—›æˆ–å¿ƒè‡Ÿç—…ç™¼ä½œå¾µè±¡",
                "åš´é‡å¤–å‚·æˆ–å¤§é‡å‡ºè¡€",
                "æ„è­˜ä¸æ¸…æˆ–æ˜è¿·",
                "åš´é‡ç‡’ç‡™å‚·",
                "ä¸­æ¯’æˆ–åš´é‡éæ•åæ‡‰",
                "éª¨æŠ˜æˆ–è„Šæ¤å—å‚·"
            ],
            "how_to_call": [
                "ä¿æŒå†·éœï¼Œæ¸…æ¥šèªªæ˜ç¾å ´ç‹€æ³",
                "æä¾›ç²¾ç¢ºçš„åœ°é»è³‡è¨Šï¼ˆåœ°å€ã€è·¯å£ã€åœ°æ¨™ï¼‰",
                "èªªæ˜å‚·è€…æ•¸é‡èˆ‡å‚·å‹¢",
                "é…åˆæŒ‡ç¤ºé€²è¡Œåˆæ­¥æ€¥æ•‘",
                "ç¢ºä¿ç¾å ´å®‰å…¨ï¼Œç­‰å¾…æ•‘æ´äººå“¡"
            ]
        }
    }

    return enhanced_docs


def enhance_monitoring_router_docs(router: APIRouter) -> Dict[str, Any]:
    """
    å¢å¼·ç›£æ§è·¯ç”±å™¨çš„æ–‡ä»¶

    Args:
        router: ç›£æ§ APIRouter å¯¦ä¾‹

    Returns:
        Dict: å¢å¼·çš„æ–‡ä»¶è³‡è¨Š
    """
    enhanced_docs = {
        "description": """
        ## ç³»çµ±ç›£æ§èˆ‡å¥åº·æª¢æŸ¥

        ### PDPA åˆè¦ç›£æ§
        - ä¸è¨˜éŒ„å€‹äººé†«ç™‚è³‡æ–™
        - å¯©è¨ˆè»Œè·¡åŠ å¯†å„²å­˜
        - è³‡æ–™ä¿ç•™æœŸé™ç®¡ç†

        ### æ•ˆèƒ½ç›£æ§æŒ‡æ¨™
        - API å›æ‡‰æ™‚é–“
        - éŒ¯èª¤ç‡çµ±è¨ˆ
        - ä½¿ç”¨é‡åˆ†æ
        """,
        "compliance_features": {
            "privacy_protection": [
                "ç—‡ç‹€æè¿°ä¸èˆ‡å€‹äººèº«ä»½é€£çµ",
                "ä½ç½®è³‡è¨Šåƒ…ç”¨æ–¼æœå°‹ï¼Œä¸ä¿å­˜",
                "å¯©è¨ˆç´€éŒ„å»è­˜åˆ¥åŒ–è™•ç†"
            ],
            "data_retention": [
                "ç³»çµ±æ—¥èªŒä¿ç•™ 30 å¤©",
                "æ•ˆèƒ½æŒ‡æ¨™ä¿ç•™ 90 å¤©",
                "å¯©è¨ˆè»Œè·¡ä¿ç•™ 1 å¹´"
            ]
        }
    }

    return enhanced_docs


def create_enhanced_router_docs() -> Dict[str, Any]:
    """
    å»ºç«‹æ‰€æœ‰è·¯ç”±å™¨çš„å¢å¼·æ–‡ä»¶

    Returns:
        Dict: å®Œæ•´çš„å¢å¼·æ–‡ä»¶å­—å…¸
    """
    return {
        "triage": enhance_triage_router_docs(None),
        "hospitals": enhance_hospitals_router_docs(None),
        "meta": enhance_meta_router_docs(None),
        "monitoring": enhance_monitoring_router_docs(None),
        "global_features": {
            "taiwan_localization": {
                "language": "ç¹é«”ä¸­æ–‡ (Traditional Chinese)",
                "region": "å°ç£ (Taiwan)",
                "address_format": "å°ç£åœ°å€æ ¼å¼æ”¯æ´",
                "phone_format": "å°ç£é›»è©±è™Ÿç¢¼æ ¼å¼"
            },
            "medical_compliance": {
                "regulatory_framework": [
                    "é†«ç™‚æ³•",
                    "ç·Šæ€¥é†«ç™‚æ•‘è­·æ³•",
                    "å€‹äººè³‡æ–™ä¿è­·æ³• (PDPA)"
                ],
                "safety_features": [
                    "ç´…æ——ç—‡ç‹€è‡ªå‹•åµæ¸¬",
                    "ç·Šæ€¥è¯çµ¡è³‡è¨Šè‡ªå‹•æä¾›",
                    "é†«ç™‚å…è²¬è²æ˜å¼·åˆ¶é¡¯ç¤º"
                ]
            },
            "technical_features": {
                "rate_limiting": "é˜²æ­¢APIæ¿«ç”¨",
                "audit_trail": "å®Œæ•´æ“ä½œè¨˜éŒ„",
                "error_handling": "è©³ç´°éŒ¯èª¤è¨Šæ¯",
                "monitoring": "å³æ™‚ç³»çµ±ç›£æ§"
            }
        }
    }


# å°ç£ç‰¹è‰²çš„ OpenAPI ç¯„ä¾‹ç”Ÿæˆå™¨
class TaiwanMedicalExampleGenerator:
    """å°ç£é†«ç™‚ API ç¯„ä¾‹ç”Ÿæˆå™¨"""

    @staticmethod
    def generate_symptom_examples() -> Dict[str, Any]:
        """ç”Ÿæˆç—‡ç‹€è©•ä¼°ç¯„ä¾‹"""
        return {
            "emergency_examples": [
                {
                    "scenario": "æ€¥æ€§å¿ƒè‚Œæ¢—å¡",
                    "symptoms": "èƒ¸éƒ¨åŠ‡ç—›ï¼Œç—›åˆ°å·¦æ‰‹è‡‚ï¼Œå†·æ±—ç›´æµ",
                    "expected_level": "emergency",
                    "expected_actions": ["ç«‹å³æ’¥æ‰“119", "å«æœç¡åŒ–ç”˜æ²¹", "å¹³èººä¼‘æ¯"]
                },
                {
                    "scenario": "åš´é‡æ°£å–˜ç™¼ä½œ",
                    "symptoms": "å‘¼å¸å›°é›£ï¼Œå–˜ä¸éæ°£ï¼Œå˜´å”‡ç™¼ç´«",
                    "expected_level": "emergency",
                    "expected_actions": ["ç«‹å³æ’¥æ‰“119", "ä½¿ç”¨æ€¥æ•‘å¸å…¥å™¨", "åç›´èº«é«”"]
                }
            ],
            "self_care_examples": [
                {
                    "scenario": "ä¸€èˆ¬æ„Ÿå†’",
                    "symptoms": "æµé¼»æ°´ï¼Œè¼•å¾®é ­ç—›ï¼Œæœ‰é»ç–²å€¦",
                    "expected_level": "self-care",
                    "expected_actions": ["å¤šä¼‘æ¯", "å¤šå–æ°´", "è§€å¯Ÿç—‡ç‹€è®ŠåŒ–"]
                }
            ]
        }

    @staticmethod
    def generate_hospital_examples() -> Dict[str, Any]:
        """ç”Ÿæˆé†«é™¢æœå°‹ç¯„ä¾‹"""
        return {
            "major_cities": {
                "å°åŒ—å¸‚": {"lat": 25.0330, "lng": 121.5654, "famous_hospitals": ["å°å¤§é†«é™¢", "æ¦®ç¸½", "é¦¬å•é†«é™¢"]},
                "æ–°åŒ—å¸‚": {"lat": 25.0173, "lng": 121.4665, "famous_hospitals": ["äºæ±é†«é™¢", "é›™å’Œé†«é™¢", "æ…ˆæ¿Ÿé†«é™¢"]},
                "æ¡ƒåœ’å¸‚": {"lat": 24.9936, "lng": 121.3010, "famous_hospitals": ["æ—å£é•·åºš", "æ¡ƒåœ’é†«é™¢", "è–ä¿ç¥¿é†«é™¢"]},
                "å°ä¸­å¸‚": {"lat": 24.1477, "lng": 120.6736, "famous_hospitals": ["ä¸­åœ‹é†«è—¥å¤§å­¸é™„é†«", "å°ä¸­æ¦®ç¸½", "æ¾„æ¸…é†«é™¢"]},
                "å°å—å¸‚": {"lat": 22.9999, "lng": 120.2269, "famous_hospitals": ["æˆå¤§é†«é™¢", "å¥‡ç¾é†«é™¢", "å°å—é†«é™¢"]},
                "é«˜é›„å¸‚": {"lat": 22.6273, "lng": 120.3014, "famous_hospitals": ["é«˜é†«é™„é†«", "é«˜é›„æ¦®ç¸½", "ç¾©å¤§é†«é™¢"]}
            }
        }